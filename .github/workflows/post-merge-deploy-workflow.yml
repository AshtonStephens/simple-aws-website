name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on:
  push:
    branches:
    - pipeline-mayhem

jobs:

  # #################################################
  # Deploy to Beta Stage
  # #################################################

  Deploy-To-Beta:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3

      - name: Set up node 18.16
        uses: actions/setup-node@v3
        with:
          node-version: 18.16.0

      # Needed for API Autogenerator
      - name: Setup Java 20
        uses: actions/setup-java@v3
        with:
          distribution: corretto
          java-version: 20

      - name: Build autogenerated api client
        working-directory: ./api_definition
        run: npm install && npm run build

      - name: Build website webpack bundle
        working-directory: ./website
        run: npm install && npm run build

      - name: Build cloudformation template
        working-directory: ./cloud_formation
        run: npm install && npm run build

        # We install cdk ourselves instead of using an existing github action for cdk cli
        # commands because all are owned by non-trusted sources, and could be updated to
        # leak our credentials.
      - name: Globally install CDK
        run: npm install -g aws-cdk@2.81.0

      - name: Deploy environment
        working-directory: ./cloud_formation
        run: cdk deploy --require-approval never
        env:
          # AWS access keys with permission to deploy to cloud formation
          # NOTE: I need full access to the repo to store secrets. This is a
          # temporary measure but very easily swapped out once I have permissions.
          AWS_ACCESS_KEY_ID: AKIA2ZSOLEBV5PGPKB66
          AWS_SECRET_ACCESS_KEY: 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

          # AWS Deployment Account and Configurations
          AWS_ACCOUNT: 742119907435 # Ashton Stephens' dev account
          AWS_REGION: us-west-2
          AWS_STAGE: beta

  # #################################################
  # Integration Tests
  # #################################################

  Integration-Test:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Placeholder"


  # #################################################
  # Deploy to Prod Stage
  # #################################################

  Deploy-To-Prod:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v3

      - name: Set up node 18.16
        uses: actions/setup-node@v3
        with:
          node-version: 18.16.0

      # Needed for API Autogenerator
      - name: Setup Java 20
        uses: actions/setup-java@v3
        with:
          distribution: corretto
          java-version: 20

      - name: Build autogenerated api client
        working-directory: ./api_definition
        run: npm install && npm run build

      - name: Build website webpack bundle
        working-directory: ./website
        run: npm install && npm run build

      - name: Build cloudformation template
        working-directory: ./cloud_formation
        run: npm install && npm run build

        # We install cdk ourselves instead of using an existing github action for cdk cli
        # commands because all are owned by non-trusted sources, and could be updated to
        # leak our credentials.
      - name: Globally install CDK
        run: npm install -g aws-cdk@2.81.0

      - name: Deploy environment
        working-directory: ./cloud_formation
        run: cdk deploy --require-approval never
        env:
          # AWS access keys with permission to deploy to cloud formation
          # NOTE: I need full access to the repo to store secrets. This is a
          # temporary measure but very easily swapped out once I have permissions.
          AWS_ACCESS_KEY_ID: AKIA2ZSOLEBV5PGPKB66
          AWS_SECRET_ACCESS_KEY: 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

          # AWS Deployment Account and Configurations
          AWS_ACCOUNT: 742119907435 # Ashton Stephens' dev account
          AWS_REGION: us-east-1
          AWS_STAGE: prod
